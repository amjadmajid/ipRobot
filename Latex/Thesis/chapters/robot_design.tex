\chapter{Robot Design and Implementation}

% - Size and weight/energy availability/speed trade-off model and 
% - Should the subsections more or less reflect the columns in the table?
% - No optical encoders because they require a lot of energy!
% - Same for linefolower / mouse sensor.

\section{Design Requirements}

% - Small form factor
% - Navigation
% - Power (should not rely on batteries)
% - Tradeoff chargetime and operation time
% - Weight of the robot
% - Low voltage decreases power consumption of components and allows efficient use of the energy from the supercapacitor
% - Single mainboard design
% - Swarm robots are typically limited to only operate on flat surfaces!
% - Limited resources (no power hungry components)
% - Optimize or low power consumption (disable or standby sensors and motor ctrl when not used)

The main requirement for the robot is  that it should be battery-less, therefore it can only store a small amount of energy in a capacitor / small buffer.
Bigger capacitors have in general larger leakage currents.
As a result these require longer charge time

Size of the robot i.e weight and the required power for movement do not scale linearly.




	
\section{Hardware Implementation}

% - EXPLAIN MORE ABOUT HARDWARE CHOISES, why these specific componens. What were the requirements for choosing these components
% - Currently only a limited amount of low power components are available which can operate at the 2.2v voltage.
% - Secondly their power consumption should be as low as possible i.e low current consumption.
 

\subsection{Computation and Sensing}

The robot is designed around a WISP 5 \ref{}, a battery-free platform for low power sensing, computation and communication.
The WISP uses a Texas Instruments MSP430FR5969 ultra low power microcontroller, operating at 16 MHz and featuring 64 KB FRAM, 2 KB SRAM and 40 IO. 
Currently only the microcontroller is being utilized, but a temperature and triaxal accelerometer are included as well. %and backscatter communication.


%The harvester IC is removed from the WISP in order to allow an external harvester to supply the power to the system by harvesting solar energy. 

% Tell about the Printed Circuit Board(PCB)
The mainboard is the platform that connects everything together.
Most reference designs are extendable but this adds complexity, while weight and size are the main constraints of this robot design.
All the added sensors are interfaced trough a I2C connection.

For avoidance of obstacles, a Maxim Integrated MAX44000 proximity sensor was added of the robot facing forward.
This sensor switches a IR led at high frequency to reduce the power consumed.
The same sensor is based around a photo-diode it can be used to measure the amount of ambient light as well.
In addition the robot has a Bosch BMG250 low power triaxial gyroscope to measure yaw-rate, used to correct it's heading when necessary.

\subsection{Locomotion}

Two 6mm geared dc motors from Precision Microdrives are mounted in a 3d printed frame, directly under the mainboard of the IPR.
The motors are mounted diagonally opposite from each other making the robot as compact as possible, while this differential drive configuration allows the robot to steer.
Small plastic wheels with rubber tires are mounted directly on each of the motor shafts.
Behind these two motors a free running caster wheel is mounted to the frame, acting as a third support point for the robot.

The speed of each motor can be controlled individually using a Texas Instruments DRV8836 dual H-bridge.
Using the IN/IN mode the motor can be enabled or disabled and direction of rotation can be controlled.


% The buck converter is can only supply 110mA of current.
% EXPLAIN IN MORE DETAIL 
% 
On average the each motor consumes 38mA while running on a flat surface, which is well within the current limit that the buck converter can supply.
However when the motors are in not moving yet the start current is approximately equal to the stall current, which is equal to 240mA.
This amount of current can not be supplied by the switch-mode regulator, PWM can be used to reduce the average current allowing a bulk capacitor to supply the voltage.

\subsection{Energy Harvesting}
\label{subsec:energy_harvesting}

% RF harvesting seems prommesing
% better to only use RF for communication and harvest energy from another source \cite{konstantioulos}
% wispcam long time to charge

%Photovoltaic cells used for indoor and outdoor energy harvesting, commonly have a different spectral sensitivity depending on the nature of their sources.
%Solar cells used in indoor applications need to have a high spectral sensitivity in the range of visible light (400 to 700nm).
%While for outdoor applications have a spectral sensitivity range can be broader, including near infrared  (500 nm to 1100 nm).
%Triple junction solar cells harvest in some cases up to 50\% of there energy out of the near infrared range.
% reference to paper tudelft!

% http://www.chip1stop.com/web/RUS/en/tutorialContents.do?page=009

The solar energy harvesting system is based around a Texas Instruments BQ25570. 
It includes a nanopower boost charger with maximum power point tracking to extract the optimal amount of energy from the solar panel. 
% Why is this size capacitor chosen?
% The harvester requires a low leakage capacitor, because the power harvested should be greater than the power leakage for t
This harvested energy is stored in a 22mF - 4.5V supercapacitor from AVX, chosen for it's low leakage current and small size.
The energy stored in supercapacitor is a function of the capacitance and voltage difference between the plates, being equal to:

\begin{equation}
\label{eq:cap1}
E = \frac{1}{2}CV^{2}
\end{equation}

However, to make efficient use of the energy stored in the capacitor a regular is required to supply a stable voltage to the connected loads.
The regulated output voltage is a lower threshold of the energy that can be used from the capacitor.
Lowering the output voltage allows for more energy to be used from the supercapacitor, but in general also lowers the power consumption of individual components. Rewriting Equation \ref{eq:cap1} results in Equation \ref{eq:cap2}:

\begin{equation}
\label{eq:cap2}
E = \frac{1}{2}C(V_{max} - V_{min})^{2}
\end{equation}

The Texas Instruments BQ25570 has a buck converter to efficiently regulate the capacitor voltage down to a system voltage of 2.2 Volt.

% The maximum speed that can be reached is dependent on the voltage supplied to the motors.
% The current consumed by the motors also decreases with a lower voltaged supplied. 
% The buck converter can supply up to 110mA of output current.
% Powering both motors and MCU should not exceed this current limit.
% Tell how resistors are used to set the minimum and maximum thresholds for the Supercap voltage and enabeling the buck converter

\subsection{Integration}

% Check hardware section ivar
% Tell why pcb is required.
% Low power compontents have chip packages which are hard to solder by hand because of their small package size.

% More stability


\section{Software Implementation}

% General library for reading and writing to i2c.

% How program consistency (ie progress) is maintained given the intermittend nature of the robot.

% A operating system for intermittend devices

\subsection{Calibration of the motors}
\label{subsub:motor_calib}

% Write about why valid to assume a constant speed on a single surface
In robotics the motors are commonly powered directly from the battery as linear or switch-mode power regulators are not able to supply the high start-up currents.
When the motors are powered from the battery the supplied voltages drops while energy is consumed for the battery.
Since the speed of the motor is dependent on the supply voltage the speed of the motor will also decrease while energy is consumed from the battery.
However, the use of a supercapacitor requires a regulator to make efficient use of the energy stored, as described in section \ref{subsec:energy_harvesting}.
A benefit of running a constant voltage is that the supply voltage is not a factor anymore which can change the motor speed.
NEED MORE EXPLANATION
By making the assumption that the robot will only travel on a flat surface, the speed is considered constant given a certain PWM duty-cycle.

% Write about linear motion control dc motor vs pwm
% Reference: https://www.precisionmicrodrives.com/application-notes/ab-022-pwm-frequency-for-linear-motion-control

Pulse width modulation(PWM) is used to control the speed of the motors, by changing the duty cycle of the control pulse the average current through the motors can be changed.
The winding current is proportional to the torgue output of the motor and therefore the average winding current is proportional to the PWM duty cycle.
However this is only true for pure resistive loads,

%Typically operation frequency is above 20 khz (what people can hear)

% -Write how the pwm control signals are generated for the H-bridge. 
EXPLAIN IN MORE DETAIL HOW THIS WORKS!
The PWM signals are generated by the microcontroller on the WISP.
Luckily the WISP has four io-ports, which can be directly controlled by a single timer.% connected to
A timer running at a frequency of 2Khz is used to directly control the four io-ports which are connected to the H-bridge.

% -Write about maximum speed due to enabling two motors and their startup current peak! show figure!!
% -Write about current generated by the lack of Back-EMF
% -Use large capacitor to somewhat reduce the effect! NEED FIGURE!

The next step is to determine the minimum and maximum PWM duty-cycle that will enable the motor to turn.
A minimal PWM duty-cycle to produce a torque that is able to overcome the static friction between the wheels and the surface the robot is moving on.
Each motor is physically different and the friction in the gearbox can variate as well, which results in a different output output speed per motor.
Since the robot uses two motors in differential drive configuration, a minimum PWM duty-cycle has to be found for each motor.
This is accomplished by setting a PWM duty-cycle at which both motors are rotating and slowly backing down the PWM duty-cycle until one or both stop turning.
The minimum PWM duty-cycle, allowing the wheel to move, is then saved and added to every motor set point.

The maximum PWM duty-cycle is bounded by the amount of current that the buck converter and bulk capacitor can supply.
Lowering the PWM duty-cycle can reduce the current peak induced by the lack of back-EMF when the motor is in steady state.

% Does more gearing (more torque) reduce the current peak??
% How does pwm influcence the startup current of the motor in combination with a capacitor

\begin{equation}
\frac{dV}{dt} = \frac{I}{C}
\end{equation}

Allow 0.2V voltage drop (msp430 and motor driver stop working)

% DO calculation of current that can be supplied from capacitor buffer

 


\subsection{PID controller for controlled movements}

% -Write about minimum output to motors (add min number), adding the minimum made it much more responsive and quicker to tune.
% -Write about bounding the pid output, because otherwise the motors of the robot could stall, if the motor setpoint is to high

% -Controlloop run periodically using a (second) timer and interrupt routine running at 50Hz
% -Different methods for calculating setpoint straight and turning
% -Explain why 100Hz precision of turning otherwise hard to reach the target within 2 deg?

% -Write about tuning the pid controller using Zieglerâ€“Nichols tuning method (method 2), closed loop, Critical gain.
% -Add figure with critcial gain + mark period Tu

The robot uses two physically different motors in differential drive configuration and they are mounted in a non-symmetrical way.
Open loop movement using just a calibrated motor values has been used in previous work \cite{legoc_uist_2016}, but it can be time consuming and any little disturbance will trow the robot off course.
The gyroscope is used to obtain the current yaw-rate and correct the robots heading.
Controlled movements are possible using closed loop feedback, where the heading is used to update the motor control values.

The robot can be controlled using three different commands, one for straight trajectories, one for left and one for right turns.
When a command is executed a control loop will run until the provided target is reached.
TELL WHY 100HZ
A timer running at a 100Hz is periodically calling a interrupt service routine which executes the control loop.   
Each command requires different initial values, set points and PID tuning parameters, these are set accordingly before the control loop is enabled.

The control loop for straight trajectories obtains the yaw-rate from the gyroscope and uses this as an input for the PID controller.
The PID will try to force the yaw-rate to zero for a given target motor speed.
Using the output of the PID controller the target motor speed of each motor is adjusted in opposite direction.
The loop will stop automatically when the required target is reached.
% Explain that the target distance is with a calibrated value.

The control loop for controlled turning uses the angle, which can be obtained by integrating the yaw-rate obtained form the gyroscope.
A P controller is used to rotate the robot to the desired angle, the proportional gain is directly influencing turn speed of the robot.
The motor values is set in opposite directions in order to rotate the robot and are equal to the output of the P controller.
These values will keep decreasing until the robot rotates to the desired angle.
When the angle set point is assumed to be reached when the angle is within two degrees of the target, in this case the loop will stop automatically.

\subsection{Persistent movement}